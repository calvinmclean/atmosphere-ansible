---
- name: this is the play for adding an ssh key to a gateone user
  hosts: atmosphere
  vars:
    EXTERNAL_HOST_KEY_NAME: "id_rsa_gateone"
    EXTERNAL_HOST_KEY_DIR: "/var/lib/gateone/users/{{ ATMOUSERNAME }}/.ssh"
    EXTERNAL_HOST_KEY_OWNER: root
    EXTERNAL_HOST_KEY_GROUP: root
    EXTERNAL_HOST: "shell"
    USERNAME: "{{ ATMOUSERNAME }}"
  roles:
    - sshkey-host-access
  tasks:
    # Gateone reads this file in the gatone user ssh directory, and uses each
    # identity found there when it tries to open an SSH connection from the
    # gateone server to the user's vm
    - name: add the key name to .default_ids
      lineinfile:
        dest: "{{ EXTERNAL_HOST_KEY_DIR }}/.default_ids"
        line: "{{ EXTERNAL_HOST_KEY_NAME }}"
        create: yes
        state: present
        owner: "{{ EXTERNAL_HOST_KEY_OWNER }}"
        group: "{{ EXTERNAL_HOST_KEY_GROUP }}"
      delegate_to: "{{ EXTERNAL_HOST }}"

- name: this is the play for adding an ssh key to a guacamole user
  hosts: atmosphere
  vars:
    EXTERNAL_HOST_KEY_DIR: "/etc/guacamole/keys/{{ ATMOUSERNAME }}"
    EXTERNAL_HOST_KEY_OWNER: tomcat7
    EXTERNAL_HOST_KEY_GROUP: tomcat7
    EXTERNAL_HOST_KEY_NAME: "_guac"
    EXTERNAL_HOST: "guac_server"
    USERNAME: "{{ ATMOUSERNAME }}"
  roles:
    - { role: "sshkey-host-access", when: SETUP_GUACAMOLE == true }
