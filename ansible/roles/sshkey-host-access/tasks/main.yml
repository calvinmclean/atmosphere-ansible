---

# This block executes on the target host
- block:
    - name: ensure the existence of the user directory
      file:
        path: "{{ EXTERNAL_HOST_KEY_DIR }}"
        owner: "{{ EXTERNAL_HOST_KEY_OWNER }}"
        group: "{{ EXTERNAL_HOST_KEY_GROUP }}"
        mode: 0700
        state: directory

    - name: check the existence of a given ssh key by name
      stat:
        path: "{{ FULL_PRIVKEY_PATH }}"
      register: existing_key

    - name: generate the keypair
      command: >
        /usr/bin/ssh-keygen -N '' -t rsa -b 2048 -f {{ EXTERNAL_HOST_KEY_DIR }}/{{ EXTERNAL_HOST_KEY_NAME }} -C {{ USERNAME }}
      when: existing_key.stat.exists == False

    - name: set the permissions on the private key file
      file:
        path: "{{ FULL_PRIVKEY_PATH }}"
        mode: 0600
        owner: "{{ EXTERNAL_HOST_KEY_OWNER }}"
        group: "{{ EXTERNAL_HOST_KEY_GROUP }}"

    - name: Ensure correct ownership of public key
      file:
        path: "{{ FULL_PUBKEY_PATH }}"
        owner: "{{ EXTERNAL_HOST_KEY_OWNER }}"
        group: "{{ EXTERNAL_HOST_KEY_GROUP }}"

    - name: transfer the public key from {{ EXTERNAL_HOST }} host to controller
      fetch:
        src: "{{ FULL_PUBKEY_PATH }}"
        dest: "{{ LOCAL_PUBKEY_DIR }}/"
        flat: yes
  delegate_to: "{{ EXTERNAL_HOST }}"

- name: add authorized access to vm from the {{ EXTERNAL_HOST }} host
  authorized_key:
    key: "{{ lookup('file', LOCAL_FULL_PUBKEY_PATH) }}"
    state: present
    user: "{{ USERNAME }}"
  tags:
    - ssh-keys
    - debug

- name: remove user key from controller node
  local_action:
    module: file
    path: "{{ LOCAL_FULL_PUBKEY_PATH }}"
    state: absent
  tags:
    - ssh-keys
    - delete-key
